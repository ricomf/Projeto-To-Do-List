import{d as E,g as h,h as q,x as _,y as w,z as L}from"./chunk-W6BZYZPR.js";import{a as P,b as O}from"./chunk-NRZIFRM7.js";import{a as j,l as v,n as m,na as f,o as g,t as k}from"./chunk-MUBZYPCN.js";import{a as b,d as A}from"./chunk-HKEYXBPG.js";import{a as d,b as u,f as T,h as c}from"./chunk-ECACSZ36.js";var I,y=T(()=>{"use strict";v();A();q();f();O();I=(()=>{let n=class n{constructor(e){this.dbService=e,this.projectsSubject=new j([]),this.projects$=this.projectsSubject.asObservable(),this.STORAGE_KEY="projects_data",this.platform=b.getPlatform(),console.log("[SqliteProjectService] Initialized on platform:",this.platform),this.loadProjects()}loadProjects(e){return c(this,null,function*(){if(console.log("[SqliteProjectService] loadProjects called, platform:",this.platform,"userId:",e),this.platform==="web"){console.log("[SqliteProjectService] Loading projects from localStorage"),this.loadProjectsFromLocalStorage(e);return}try{console.log("[SqliteProjectService] Attempting to get database connection for loading projects...");let t=yield this.dbService.getDb();console.log("[SqliteProjectService] Database connection obtained for loading projects");let r=`
        SELECT
          p.id,
          p.nome,
          p.descricao,
          p.cor,
          p.criado_por as ownerId,
          p.status,
          p.data_criacao as dataCriacao,
          p.data_atualizacao as dataAtualizacao
        FROM projects p
      `;e&&(r+=`
          LEFT JOIN project_members pm ON p.id = pm.project_id
          WHERE p.criado_por = ? OR pm.user_id = ?
          GROUP BY p.id
        `),console.log("[SqliteProjectService] Executing query:",r);let o=e?yield t.query(r,[e,e]):yield t.query(r);if(console.log("[SqliteProjectService] Query result:",o),o?.values){console.log("[SqliteProjectService] Found",o.values.length,"projects");let a=yield Promise.all(o.values.map(s=>c(this,null,function*(){let i=yield this.getProjectMembers(s.id),S=yield this.getProjectTasks(s.id);return{id:s.id,nome:s.nome,descricao:s.descricao,cor:s.cor,icon:"briefcase",ownerId:s.ownerId,status:s.status,dataCriacao:s.dataCriacao,dataAtualizacao:s.dataAtualizacao,members:i,tasks:S}})));console.log("[SqliteProjectService] Projects loaded:",a),this.projectsSubject.next(a)}else console.log("[SqliteProjectService] No projects found in result"),this.projectsSubject.next([])}catch(t){console.error("[SqliteProjectService] \u274C Error loading projects from SQLite:",t),console.error("[SqliteProjectService] Error details:",{name:t?.name,message:t?.message,stack:t?.stack}),console.log("[SqliteProjectService] \u{1F504} Falling back to localStorage for loading..."),this.loadProjectsFromLocalStorage(e)}})}loadProjectsFromLocalStorage(e){try{let t=localStorage.getItem(this.STORAGE_KEY),r=t?JSON.parse(t):[];e&&(r=r.filter(a=>a.ownerId===e||a.members?.some(s=>s.userId===e)));let o=localStorage.getItem("user_tasks");if(o){let a=JSON.parse(o);r=r.map(s=>u(d({},s),{tasks:a.filter(i=>i.projectId===s.id).map(i=>i.id)}))}this.projectsSubject.next(r)}catch(t){console.error("[SqliteProjectService] Error loading from localStorage:",t),this.projectsSubject.next([])}}saveProjectsToLocalStorage(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){console.error("[SqliteProjectService] Error saving to localStorage:",t)}}getProjectMembers(e){return c(this,null,function*(){try{let r=yield(yield this.dbService.getDb()).query(`
        SELECT
          pm.user_id as userId,
          u.nome,
          u.email,
          u.avatar_url as avatarUrl,
          pm.role,
          pm.adicionado_em as dataEntrada
        FROM project_members pm
        LEFT JOIN users u ON pm.user_id = u.id
        WHERE pm.project_id = ?
      `,[e]);return r?.values?r.values.map(o=>({userId:o.userId,nome:o.nome||"Usu\xE1rio",email:o.email||"",avatarUrl:o.avatarUrl,role:o.role,dataEntrada:o.dataEntrada})):[]}catch(t){return console.error("Error loading project members:",t),[]}})}getProjectTasks(e){return c(this,null,function*(){try{let r=yield(yield this.dbService.getDb()).query(`
        SELECT id FROM tasks WHERE project_id = ?
      `,[e]);return r?.values?r.values.map(o=>o.id):[]}catch(t){return console.error("Error loading project tasks:",t),[]}})}getProjects(){return this.projects$}getProjectById(e){return this.projectsSubject.value.find(t=>t.id===e)}createProject(e,t){return c(this,null,function*(){if(console.log("[SqliteProjectService] Creating project with dto:",e,"userId:",t),console.log("[SqliteProjectService] Platform:",this.platform),this.platform==="web")return this.createProjectInLocalStorage(e,t);try{console.log("[SqliteProjectService] Attempting to get database connection...");let r=yield this.dbService.getDb();console.log("[SqliteProjectService] Database connection obtained successfully");let o=new Date().toISOString(),a=this.generateId();console.log("[SqliteProjectService] Generated project ID:",a);let s=`
        INSERT INTO projects (
          id, nome, descricao, cor, is_public, criado_por,
          status, data_criacao, data_atualizacao
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `,i=[a,e.nome,e.descricao||"",e.cor||"#3880ff",0,t,h.ACTIVE,o,o];console.log("[SqliteProjectService] Executing insert with values:",i),yield r.run(s,i),console.log("[SqliteProjectService] Project inserted successfully"),console.log("[SqliteProjectService] Adding owner as member"),yield this.addMemberToProject(a,{userId:t,nome:"Voc\xEA",email:"",role:"OWNER"}),console.log("[SqliteProjectService] Saving to store"),yield this.dbService.saveToStore(),console.log("[SqliteProjectService] Reloading projects"),yield this.loadProjects();let S=this.getProjectById(a);return console.log("[SqliteProjectService] Created project:",S),S||null}catch(r){console.error("[SqliteProjectService] \u274C Error creating project in SQLite:",r),console.error("[SqliteProjectService] Error details:",{name:r?.name,message:r?.message,stack:r?.stack}),console.log("[SqliteProjectService] \u{1F504} Falling back to localStorage...");try{let o=this.createProjectInLocalStorage(e,t);return console.log("[SqliteProjectService] \u2705 Project created in localStorage fallback:",o),o}catch(o){return console.error("[SqliteProjectService] \u274C Fallback to localStorage also failed:",o),null}}})}createProjectInLocalStorage(e,t){console.log("[SqliteProjectService] Creating project in localStorage");let r=new Date().toISOString(),a={id:this.generateId(),nome:e.nome,descricao:e.descricao,cor:e.cor||"#3880ff",icon:"briefcase",status:h.ACTIVE,ownerId:t,dataCriacao:r,dataAtualizacao:r,tasks:[],members:[{userId:t,nome:"Voc\xEA",email:"",role:"OWNER",dataEntrada:r}]},s=this.getAllProjectsFromLocalStorage();return s.push(a),this.saveProjectsToLocalStorage(s),this.projectsSubject.next(s),console.log("[SqliteProjectService] Project created in localStorage:",a),a}getAllProjectsFromLocalStorage(){try{let e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("[SqliteProjectService] Error reading from localStorage:",e),[]}}updateProject(e,t){return c(this,null,function*(){if(this.platform==="web")return this.updateProjectInLocalStorage(e,t);try{let r=yield this.dbService.getDb(),o=new Date().toISOString(),a=[],s=[];if(t.nome!==void 0&&(a.push("nome = ?"),s.push(t.nome)),t.descricao!==void 0&&(a.push("descricao = ?"),s.push(t.descricao)),t.cor!==void 0&&(a.push("cor = ?"),s.push(t.cor)),t.status!==void 0&&(a.push("status = ?"),s.push(t.status)),a.length===0)return this.getProjectById(e)||null;a.push("data_atualizacao = ?"),s.push(o),s.push(e);let i=`UPDATE projects SET ${a.join(", ")} WHERE id = ?`;return yield r.run(i,s),yield this.dbService.saveToStore(),yield this.loadProjects(),this.getProjectById(e)||null}catch(r){return console.error("Error updating project:",r),null}})}updateProjectInLocalStorage(e,t){let r=this.getAllProjectsFromLocalStorage(),o=r.findIndex(s=>s.id===e);if(o===-1)return null;let a=new Date().toISOString();return r[o]=u(d(d({},r[o]),t),{dataAtualizacao:a}),this.saveProjectsToLocalStorage(r),this.loadProjectsFromLocalStorage(),this.projectsSubject.value.find(s=>s.id===e)||null}deleteProject(e){return c(this,null,function*(){if(this.platform==="web")return this.deleteProjectInLocalStorage(e);try{return yield(yield this.dbService.getDb()).run("DELETE FROM projects WHERE id = ?",[e]),yield this.dbService.saveToStore(),yield this.loadProjects(),!0}catch(t){return console.error("Error deleting project:",t),!1}})}deleteProjectInLocalStorage(e){let t=this.getAllProjectsFromLocalStorage(),r=t.filter(o=>o.id!==e);return r.length===t.length?!1:(this.saveProjectsToLocalStorage(r),this.projectsSubject.next(r),!0)}archiveProject(e){return c(this,null,function*(){return this.updateProject(e,{status:h.ARCHIVED})})}completeProject(e){return c(this,null,function*(){return this.updateProject(e,{status:h.COMPLETED})})}addMemberToProject(e,t){return c(this,null,function*(){if(this.platform==="web")return console.log("[SqliteProjectService] Skipping addMemberToProject on web platform (handled in localStorage)"),!0;try{let r=yield this.dbService.getDb(),o=this.generateId(),a=new Date().toISOString();return yield r.run(`
        INSERT INTO project_members (id, project_id, user_id, role, adicionado_em)
        VALUES (?, ?, ?, ?, ?)
      `,[o,e,t.userId,t.role,a]),yield this.dbService.saveToStore(),yield this.loadProjects(),!0}catch(r){return console.error("[SqliteProjectService] \u274C Error adding member:",r),console.error("[SqliteProjectService] Error details:",{name:r?.name,message:r?.message}),!1}})}removeMemberFromProject(e,t){return c(this,null,function*(){try{let r=this.getProjectById(e);return!r||r.ownerId===t?!1:(yield(yield this.dbService.getDb()).run("DELETE FROM project_members WHERE project_id = ? AND user_id = ?",[e,t]),yield this.dbService.saveToStore(),yield this.loadProjects(),!0)}catch(r){return console.error("Error removing member:",r),!1}})}addTaskToProject(e,t){return c(this,null,function*(){if(this.platform==="web")return this.loadProjectsFromLocalStorage(),!0;try{return yield(yield this.dbService.getDb()).run("UPDATE tasks SET project_id = ? WHERE id = ?",[e,t]),yield this.dbService.saveToStore(),yield this.loadProjects(),!0}catch(r){return console.error("Error adding task to project:",r),!1}})}removeTaskFromProject(e){return c(this,null,function*(){if(this.platform==="web")return this.loadProjectsFromLocalStorage(),!0;try{return yield(yield this.dbService.getDb()).run("UPDATE tasks SET project_id = NULL WHERE id = ?",[e]),yield this.dbService.saveToStore(),yield this.loadProjects(),!0}catch(t){return console.error("Error removing task from project:",t),!1}})}refreshProjects(e){this.platform==="web"?this.loadProjectsFromLocalStorage(e):this.loadProjects(e)}generateId(){return`${Date.now()}_${Math.random().toString(36).substring(2,11)}`}};n.\u0275fac=function(t){return new(t||n)(g(P))},n.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"});let l=n;return l})()});var Y,F=T(()=>{"use strict";v();_();y();f();L();Y=(()=>{let n=class n{constructor(e,t){this.authService=e,this.injector=t,this.tasksSubject=new j([]),this.tasks$=this.tasksSubject.asObservable(),this.TASKS_STORAGE_KEY="user_tasks",console.log("[TaskService] Initialized"),this.initializeTaskService(),this.loadTasksFromStorage(),this.authService.currentUser$.subscribe(r=>{r?(console.log("[TaskService] User logged in, reloading tasks..."),this.refreshUserTasks()):(console.log("[TaskService] User logged out, clearing tasks..."),this.tasksSubject.next([]))})}initializeTaskService(){return c(this,null,function*(){let e=window.Capacitor?.getPlatform()||"web";if(console.log("[TaskService] Platform detected:",e),console.log("[TaskService] \u2705 Using localStorage for ALL platforms (reliable persistence)"),e!=="web")try{console.log("[TaskService] Waiting for auth initialization..."),yield this.authService.waitForInit(),console.log("[TaskService] Auth initialization complete")}catch(t){console.warn("[TaskService] Auth initialization warning:",t)}})}ensureInitialized(){return c(this,null,function*(){yield this.authService.waitForInit()})}getProjectService(){if(!this.projectService)try{this.projectService=this.injector.get(I)}catch(e){console.warn("[TaskService] Could not get SqliteProjectService:",e);return}return this.projectService}refreshProjectCounts(){try{let e=this.getProjectService();if(e&&e.refreshProjects){let t=this.authService.getCurrentUserId();e.refreshProjects(t||void 0)}}catch(e){console.warn("[TaskService] Could not refresh project counts:",e)}}refreshUserTasks(){console.log("[TaskService] Refreshing tasks for current user..."),this.loadTasksFromStorage()}loadTasksFromStorage(){try{let e=this.authService.currentUserValue?.id,t=localStorage.getItem(this.TASKS_STORAGE_KEY);if(t){let r=JSON.parse(t);e?(r=r.filter(o=>o.userId===e),console.log(`[TaskService] \u2705 Loaded ${r.length} tasks for user ${e}`)):(r=[],console.log("[TaskService] \u26A0\uFE0F No user logged in, loading empty tasks")),this.tasksSubject.next(r)}else console.log("[TaskService] No tasks found in localStorage"),this.tasksSubject.next([])}catch(e){console.error("[TaskService] Error loading tasks from localStorage:",e),this.tasksSubject.next([])}}saveTasksToStorage(e){try{localStorage.setItem(this.TASKS_STORAGE_KEY,JSON.stringify(e)),console.log(`[TaskService] \u2705 Saved ${e.length} tasks to localStorage`)}catch(t){console.error("[TaskService] Error saving tasks to localStorage:",t)}}getTasks(){return c(this,null,function*(){try{console.log("[TaskService] getTasks() called"),yield this.ensureInitialized();let e=this.authService.currentUserValue?.id;if(console.log("[TaskService] User ID:",e),!e)return console.log("[TaskService] \u26A0\uFE0F No userId, returning empty tasks"),[];console.log("[TaskService] Using localStorage for tasks");let t=localStorage.getItem(this.TASKS_STORAGE_KEY),r=[];return t&&(r=JSON.parse(t)),r=r.filter(o=>o.userId===e),console.log("[TaskService] \u2705 Got",r.length,"tasks from localStorage"),this.tasksSubject.next(r),console.log("[TaskService] Tasks updated in subject. Total:",r.length),r}catch(e){return console.error("[TaskService] \u274C Error fetching tasks:",e),console.error("[TaskService] Error details:",JSON.stringify(e)),[]}})}getTaskById(e){return c(this,null,function*(){try{let t=localStorage.getItem(this.TASKS_STORAGE_KEY);return t&&JSON.parse(t).find(o=>o.id===e)||null}catch(t){return console.error("Error fetching task:",t),null}})}getTask(e){return c(this,null,function*(){try{let t=e.toString(),r=localStorage.getItem(this.TASKS_STORAGE_KEY);if(r){let a=JSON.parse(r).find(s=>s.id===t||s.id===e);return console.log("[TaskService] getTask:",e,"found:",a?"yes":"no"),a||null}return null}catch(t){return console.error("[TaskService] Error fetching task:",t),null}})}createTask(e){return c(this,null,function*(){try{console.log("[TaskService] ========== CREATE TASK START =========="),console.log("[TaskService] taskData:",JSON.stringify(e,null,2)),console.log("[TaskService] Ensuring initialization..."),yield this.ensureInitialized(),console.log("[TaskService] Initialization complete");let t=this.authService.currentUserValue?.id;if(console.log("[TaskService] - userId:",t),!t)throw console.error("[TaskService] \u274C ERROR: Usu\xE1rio n\xE3o autenticado"),new Error("Usu\xE1rio n\xE3o autenticado");console.log("[TaskService] \u27A1\uFE0F  Creating task in localStorage...");let r=this.createMockTask(e,t);console.log("[TaskService] \u2705 Task created successfully!"),console.log("[TaskService] Task ID:",r.id),console.log("[TaskService] Task ProjectId:",r.projectId);let a=[...this.tasksSubject.value,r];this.tasksSubject.next(a);let s=localStorage.getItem(this.TASKS_STORAGE_KEY),i=s?JSON.parse(s):[];return i.push(r),this.saveTasksToStorage(i),this.refreshProjectCounts(),console.log("[TaskService] Task list updated. Total tasks:",a.length),console.log("[TaskService] ========== CREATE TASK END =========="),r}catch(t){throw console.error("[TaskService] ========== CREATE TASK FAILED =========="),console.error("[TaskService] \u274C Error:",t),console.error("[TaskService] Error message:",t?.message),console.error("[TaskService] Error stack:",t?.stack),t}})}createMockTask(e,t){let r=new Date;return{id:"task-"+Date.now()+"-"+Math.random().toString(36).substring(2,11),titulo:e.titulo,descricao:e.descricao||"",status:E.TODO,prioridade:e.prioridade||"medium",dataCriacao:r,dataAtualizacao:r,dataVencimento:e.dataVencimento,userId:t,projectId:e.projectId,categoryId:e.categoryId,tags:e.tags||[],isPublic:!1,assignedTo:[],anexos:[]}}updateTask(e,t){return c(this,null,function*(){try{let r=localStorage.getItem(this.TASKS_STORAGE_KEY),o=r?JSON.parse(r):[],a=o.findIndex(p=>p.id===e);if(a===-1)throw new Error("Task not found");let s=u(d(d({},o[a]),t),{dataAtualizacao:new Date});o[a]=s,this.saveTasksToStorage(o);let i=this.tasksSubject.value,S=i.findIndex(p=>p.id===e);return S!==-1?(i[S]=s,this.tasksSubject.next([...i])):this.loadTasksFromStorage(),t.projectId!==void 0&&this.refreshProjectCounts(),s}catch(r){throw console.error("[TaskService] Error updating task:",r),r}})}deleteTask(e){return c(this,null,function*(){try{let t=localStorage.getItem(this.TASKS_STORAGE_KEY),r=t?JSON.parse(t):[];r=r.filter(a=>a.id!==e),this.saveTasksToStorage(r);let o=this.tasksSubject.value;this.tasksSubject.next(o.filter(a=>a.id!==e)),this.refreshProjectCounts()}catch(t){throw console.error("[TaskService] Error deleting task:",t),t}})}getTasksByProject(e){return c(this,null,function*(){try{let t=localStorage.getItem(this.TASKS_STORAGE_KEY);return t?JSON.parse(t).filter(o=>o.projectId===e):[]}catch(t){return console.error("Error fetching project tasks:",t),[]}})}getTasksByStatus(e){return this.tasksSubject.value.filter(t=>t.status===e)}searchTasks(e){let t=e.toLowerCase();return this.tasksSubject.value.filter(r=>r.titulo.toLowerCase().includes(t)||r.descricao?.toLowerCase().includes(t)||r.tags.some(o=>o.toLowerCase().includes(t)))}};n.\u0275fac=function(t){return new(t||n)(g(w),g(k))},n.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"});let l=n;return l})()});export{I as a,y as b,Y as c,F as d};
