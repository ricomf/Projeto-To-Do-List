import{a as x,b as B}from"./chunk-NRZIFRM7.js";import{Aa as le,a as D,e as L,f as O,g as k,j as T,l as C,n as S,na as _,o as m,u as ce,xa as M}from"./chunk-MUBZYPCN.js";import{a as f,b as g,f as d,h as n}from"./chunk-ECACSZ36.js";var A,K=d(()=>{"use strict";A=(function(o){return o.ADMIN="ADMIN",o.USER="USER",o.GUEST="GUEST",o})(A||{})});var w,I,P=d(()=>{"use strict";w=(function(o){return o.TODO="TODO",o.IN_PROGRESS="IN_PROGRESS",o.COMPLETED="COMPLETED",o.CANCELLED="CANCELLED",o})(w||{}),I=(function(o){return o.LOW="LOW",o.MEDIUM="MEDIUM",o.HIGH="HIGH",o.URGENT="URGENT",o})(I||{})});var ue,Q=d(()=>{"use strict";ue=(function(o){return o.ACTIVE="ACTIVE",o.COMPLETED="COMPLETED",o.ARCHIVED="ARCHIVED",o.ON_HOLD="ON_HOLD",o})(ue||{})});var F=d(()=>{"use strict"});var H=d(()=>{"use strict"});var p,U,V,j,z,J,v,W,G,Y,$,N,q,X,l,ge,Z=d(()=>{"use strict";p=class extends Error{constructor(s,c="UNKNOWN_ERROR",t=!0){super(s),this.name=this.constructor.name,this.code=c,this.isOperational=t,this.timestamp=new Date,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,this.constructor)}toJSON(){return{name:this.name,message:this.message,code:this.code,timestamp:this.timestamp,isOperational:this.isOperational,stack:this.stack}}},U=class extends p{constructor(s="Erro de autentica\xE7\xE3o",c="AUTH_ERROR"){super(s,c,!0)}},V=class extends U{constructor(s="Credenciais inv\xE1lidas"){super(s,"INVALID_CREDENTIALS")}},j=class extends U{constructor(s="Token expirado"){super(s,"TOKEN_EXPIRED")}},z=class extends U{constructor(s="Acesso n\xE3o autorizado"){super(s,"UNAUTHORIZED")}},J=class extends p{constructor(s="Erro de valida\xE7\xE3o",c){super(s,"VALIDATION_ERROR",!0),this.fields=c}toJSON(){return g(f({},super.toJSON()),{fields:this.fields})}},v=class extends p{constructor(s="Erro de rede",c,t,e="NETWORK_ERROR"){super(s,e,!0),this.statusCode=c,this.url=t}toJSON(){return g(f({},super.toJSON()),{statusCode:this.statusCode,url:this.url})}},W=class extends v{constructor(s="Tempo de requisi\xE7\xE3o esgotado",c){super(s,408,c,"TIMEOUT_ERROR")}},G=class extends v{constructor(s="Erro do servidor",c=500,t){super(s,c,t,"SERVER_ERROR")}},Y=class extends v{constructor(s="Recurso n\xE3o encontrado",c){super(s,404,c,"NOT_FOUND")}},$=class extends p{constructor(s="Erro no banco de dados",c){super(s,"DATABASE_ERROR",!0),this.query=c}toJSON(){return g(f({},super.toJSON()),{query:this.query})}},N=class extends p{constructor(s,c="BUSINESS_ERROR"){super(s,c,!0)}},q=class extends N{constructor(s="Recurso j\xE1 existe"){super(s,"CONFLICT_ERROR")}},X=class extends p{constructor(s="Erro inesperado",c){super(s,"UNEXPECTED_ERROR",!1),c&&(this.stack=c.stack||this.stack)}},l={AUTH_ERROR:"AUTH_ERROR",INVALID_CREDENTIALS:"INVALID_CREDENTIALS",TOKEN_EXPIRED:"TOKEN_EXPIRED",UNAUTHORIZED:"UNAUTHORIZED",VALIDATION_ERROR:"VALIDATION_ERROR",NETWORK_ERROR:"NETWORK_ERROR",TIMEOUT_ERROR:"TIMEOUT_ERROR",SERVER_ERROR:"SERVER_ERROR",NOT_FOUND:"NOT_FOUND",DATABASE_ERROR:"DATABASE_ERROR",BUSINESS_ERROR:"BUSINESS_ERROR",CONFLICT_ERROR:"CONFLICT_ERROR",RESOURCE_NOT_FOUND:"RESOURCE_NOT_FOUND",PERMISSION_DENIED:"PERMISSION_DENIED",STORAGE_ERROR:"STORAGE_ERROR",STORAGE_QUOTA_EXCEEDED:"STORAGE_QUOTA_EXCEEDED",UNEXPECTED_ERROR:"UNEXPECTED_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR"},ge={[l.AUTH_ERROR]:"Erro de autentica\xE7\xE3o. Por favor, tente novamente.",[l.INVALID_CREDENTIALS]:"Email ou senha incorretos.",[l.TOKEN_EXPIRED]:"Sua sess\xE3o expirou. Por favor, fa\xE7a login novamente.",[l.UNAUTHORIZED]:"Voc\xEA n\xE3o tem permiss\xE3o para acessar este recurso.",[l.VALIDATION_ERROR]:"Os dados fornecidos s\xE3o inv\xE1lidos.",[l.NETWORK_ERROR]:"Erro de conex\xE3o. Verifique sua internet.",[l.TIMEOUT_ERROR]:"A requisi\xE7\xE3o demorou muito. Tente novamente.",[l.SERVER_ERROR]:"Erro no servidor. Tente novamente mais tarde.",[l.NOT_FOUND]:"Recurso n\xE3o encontrado.",[l.DATABASE_ERROR]:"Erro ao acessar os dados.",[l.CONFLICT_ERROR]:"Este recurso j\xE1 existe.",[l.RESOURCE_NOT_FOUND]:"Recurso n\xE3o encontrado.",[l.PERMISSION_DENIED]:"Voc\xEA n\xE3o tem permiss\xE3o para realizar esta a\xE7\xE3o.",[l.STORAGE_ERROR]:"Erro ao salvar dados.",[l.STORAGE_QUOTA_EXCEEDED]:"Espa\xE7o de armazenamento insuficiente.",[l.UNEXPECTED_ERROR]:"Ocorreu um erro inesperado.",[l.UNKNOWN_ERROR]:"Ocorreu um erro desconhecido."}});var y=d(()=>{"use strict";F();K();P();H();Q();Z()});var ee,te=d(()=>{"use strict";ee={production:!0,apiUrl:"https://api.yourdomain.com/api",appVersion:"1.0.0",appName:"To-Do App"}});var re,se=d(()=>{"use strict";C();ce();te();_();le();re=(()=>{let s=class s{constructor(t){this.http=t,this.apiUrl=ee.apiUrl}get(t,e){return this.http.get(`${this.apiUrl}/${t}`,e).pipe(k(r=>r),T(this.handleError))}post(t,e,r){return this.http.post(`${this.apiUrl}/${t}`,e,r).pipe(k(a=>a),T(this.handleError))}put(t,e,r){return this.http.put(`${this.apiUrl}/${t}`,e,r).pipe(k(a=>a),T(this.handleError))}patch(t,e,r){return this.http.patch(`${this.apiUrl}/${t}`,e,r).pipe(k(a=>a),T(this.handleError))}delete(t,e){return this.http.delete(`${this.apiUrl}/${t}`,e).pipe(k(r=>r),T(this.handleError))}handleError(t){let e="Ocorreu um erro desconhecido";return t.error instanceof ErrorEvent?e=`Erro: ${t.error.message}`:e=t.error?.message||`Erro ${t.status}: ${t.statusText}`,console.error("API Error:",t),L(()=>new Error(e))}};s.\u0275fac=function(e){return new(e||s)(m(M))},s.\u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"});let o=s;return o})()});var oe,ae=d(()=>{"use strict";y();_();oe=(()=>{let s=class s{constructor(){this.STORAGE_KEY="mock_users",this.TASKS_KEY="mock_tasks",this.initializeMockData()}initializeMockData(){if(localStorage.getItem(this.STORAGE_KEY)){let t=this.getUsers();console.log(`[MockBackend] \u2705 Found ${t.length} existing user(s) in localStorage`)}else{let t={id:"mock-user-123",nome:"Mock Test User",email:"test@mock.com",password:"password",avatarUrl:null,roles:[A.USER],dataCriacao:new Date,dataAtualizacao:new Date,ativo:!0};localStorage.setItem(this.STORAGE_KEY,JSON.stringify([t])),console.log("[MockBackend] \u2705 Mock data initialized with default user: test@mock.com / password")}localStorage.getItem(this.TASKS_KEY)||(localStorage.setItem(this.TASKS_KEY,JSON.stringify(this.getDefaultTasks())),console.log("[MockBackend] \u2705 Mock tasks initialized"))}login(t){return n(this,null,function*(){yield this.delay(500);let r=this.getUsers().find(a=>a.email===t.email);if(!r)throw console.error(`[MockBackend] Login falhou: Usu\xE1rio ${t.email} n\xE3o encontrado.`),new Error("Email ou senha inv\xE1lidos");if(r.password!==t.password)throw console.error(`[MockBackend] Login falhou: Senha incorreta para ${t.email}.`),new Error("Email ou senha inv\xE1lidos");return console.log(`[MockBackend] \u2705 Login bem-sucedido para: ${r.email}`),this.createAuthResponse(r)})}register(t){return n(this,null,function*(){yield this.delay(500);let e=this.getUsers();if(e.find(a=>a.email===t.email))throw new Error("Email j\xE1 cadastrado");if(t.password!==t.confirmPassword)throw new Error("As senhas n\xE3o coincidem");let r={id:this.generateId(),nome:t.nome,email:t.email,password:t.password,avatarUrl:null,roles:[A.USER],dataCriacao:new Date,dataAtualizacao:new Date,ativo:!0};return e.push(r),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),this.createAuthResponse(r)})}createAuthResponse(t){let e=this.generateToken(),r=this.generateToken();return{user:{id:t.id,nome:t.nome,email:t.email,avatarUrl:t.avatarUrl,roles:t.roles},token:e,refreshToken:r,expiresIn:3600}}updateUser(t,e){return n(this,null,function*(){yield this.delay(300);let r=this.getUsers(),a=r.findIndex(u=>u.id===t);if(a===-1)throw new Error("Usu\xE1rio n\xE3o encontrado");let i=r[a];if(e.nome!==void 0&&(i.nome=e.nome),e.email!==void 0){if(r.some(E=>E.id!==t&&E.email===e.email))throw new Error("Email j\xE1 est\xE1 em uso");i.email=e.email}return e.avatarUrl!==void 0&&(i.avatarUrl=e.avatarUrl),i.dataAtualizacao=new Date,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),console.log("[MockBackend] \u2705 User updated successfully"),i})}getUsers(){let t=localStorage.getItem(this.STORAGE_KEY);return t?JSON.parse(t):[]}generateId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}generateToken(){return"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjEyMyIsImVtYWlsIjoidGVzdEBtb2NrLmNvbSJ9.S"+Math.random().toString(36).substring(2)}delay(t){return new Promise(e=>setTimeout(e,t))}getDefaultTasks(){return[{id:"1",titulo:"Configurar projeto Ionic",descricao:"Instalar depend\xEAncias e configurar ambiente de desenvolvimento",status:w.COMPLETED,dataVencimento:new Date("2025-10-10"),dataCriacao:new Date("2025-10-01"),dataAtualizacao:new Date("2025-10-05"),prioridade:I.HIGH,userId:"mock-user-123",tags:["setup","desenvolvimento"],isPublic:!1,assignedTo:["mock-user-123"],completed:!0,completedAt:new Date("2025-10-05")},{id:"2",titulo:"Implementar autentica\xE7\xE3o JWT",descricao:"Criar sistema de login com tokens JWT e refresh tokens",status:w.IN_PROGRESS,dataVencimento:new Date("2025-10-15"),dataCriacao:new Date("2025-10-02"),dataAtualizacao:new Date("2025-10-07"),prioridade:I.URGENT,userId:"mock-user-123",tags:["backend","seguran\xE7a"],isPublic:!1,assignedTo:["mock-user-123"]},{id:"3",titulo:"Design de UI/UX",descricao:"Criar mockups e prot\xF3tipos para as principais telas",status:w.TODO,dataVencimento:new Date("2025-10-20"),dataCriacao:new Date("2025-10-03"),dataAtualizacao:new Date("2025-10-03"),prioridade:I.MEDIUM,userId:"mock-user-123",tags:["design","ui/ux"],isPublic:!1,assignedTo:["mock-user-123"]},{id:"4",titulo:"Implementar tema escuro",descricao:"Adicionar suporte completo para modo escuro",status:w.TODO,dataVencimento:new Date("2025-10-25"),dataCriacao:new Date("2025-10-04"),dataAtualizacao:new Date("2025-10-04"),prioridade:I.LOW,userId:"mock-user-123",tags:["frontend","ui"],isPublic:!1,assignedTo:["mock-user-123"]}]}};s.\u0275fac=function(e){return new(e||s)},s.\u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"});let o=s;return o})()});var ie,ne=d(()=>{"use strict";y();_();B();ie=(()=>{let s=class s{constructor(t){this.db=t}hashPassword(t){return n(this,null,function*(){let r=new TextEncoder().encode(t),a=yield crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(a)).map(u=>u.toString(16).padStart(2,"0")).join("")})}verifyPassword(t,e){return n(this,null,function*(){return(yield this.hashPassword(t))===e})}register(t){return n(this,null,function*(){try{let e=yield this.db.query("SELECT * FROM users WHERE email = ?",[t.email]);if(e.values&&e.values.length>0)throw new Error("Email j\xE1 cadastrado");let r=yield this.hashPassword(t.password),a=this.db.generateId(),i=this.db.dateToSQL(new Date);yield this.db.run(`INSERT INTO users (id, nome, email, password, roles, data_criacao, ultima_atualizacao)
         VALUES (?, ?, ?, ?, ?, ?, ?)`,[a,t.nome,t.email,r,JSON.stringify([A.USER]),i,i]),yield this.db.run(`INSERT INTO user_preferences (user_id, tema, idioma, notificacoes_push, notificacoes_email)
         VALUES (?, ?, ?, ?, ?)`,[a,"auto","pt-BR",1,1]);let u=this.generateToken(),E=this.generateToken(),h=this.db.dateToSQL(new Date(Date.now()+1440*60*1e3));yield this.db.run(`INSERT INTO auth_tokens (user_id, token, refresh_token, expires_at)
         VALUES (?, ?, ?, ?)`,[a,u,E,h]),console.log("[SQLiteAuth] Forcing database save after registration..."),yield this.db.forceSave(),console.log("[SQLiteAuth] \u2705 Database saved successfully");let R=yield this.getUserById(a);if(!R)throw new Error("Erro ao criar usu\xE1rio");return{user:{id:R.id,nome:R.nome,email:R.email,avatarUrl:R.avatarUrl,roles:R.roles},token:u,refreshToken:E,expiresIn:86400}}catch(e){throw new Error(e.message||"Erro ao criar conta")}})}login(t){return n(this,null,function*(){try{console.log("[SQLiteAuth] Login attempt for:",t.email);let e=yield this.db.query("SELECT * FROM users WHERE email = ?",[t.email]);if(console.log("[SQLiteAuth] Query result:",e),!e.values||e.values.length===0)throw console.error("[SQLiteAuth] \u274C Usu\xE1rio n\xE3o encontrado. Negando login."),new Error("Email ou senha inv\xE1lidos");let r=e.values[0];if(console.log("[SQLiteAuth] User found:",r.email),!(yield this.verifyPassword(t.password,r.password)))throw console.error("[SQLiteAuth] \u274C Senha inv\xE1lida."),new Error("Email ou senha inv\xE1lidos");console.log("[SQLiteAuth] Password verified");let i=this.generateToken(),u=this.generateToken(),E=this.db.dateToSQL(new Date(Date.now()+1440*60*1e3));yield this.db.run(`INSERT OR REPLACE INTO auth_tokens (user_id, token, refresh_token, expires_at)
         VALUES (?, ?, ?, ?)`,[r.id,i,u,E]);let h=yield this.getUserById(r.id);if(!h)throw new Error("Erro ao buscar dados do usu\xE1rio");return console.log("[SQLiteAuth] Login successful, returning response"),{user:{id:h.id,nome:h.nome,email:h.email,avatarUrl:h.avatarUrl,roles:h.roles},token:i,refreshToken:u,expiresIn:86400}}catch(e){throw new Error(e.message||"Erro ao fazer login")}})}logout(t){return n(this,null,function*(){yield this.db.run("DELETE FROM auth_tokens WHERE user_id = ?",[t])})}refreshToken(t){return n(this,null,function*(){try{let e=yield this.db.query("SELECT * FROM auth_tokens WHERE refresh_token = ?",[t]);if(!e.values||e.values.length===0)return null;let r=e.values[0];if(new Date(r.expires_at)<new Date)return yield this.db.run("DELETE FROM auth_tokens WHERE user_id = ?",[r.user_id]),null;let i=this.generateToken(),u=this.generateToken(),E=this.db.dateToSQL(new Date(Date.now()+1440*60*1e3));yield this.db.run("UPDATE auth_tokens SET token = ?, refresh_token = ?, expires_at = ? WHERE user_id = ?",[i,u,E,r.user_id]);let h=yield this.getUserById(r.user_id);return h?{user:{id:h.id,nome:h.nome,email:h.email,avatarUrl:h.avatarUrl,roles:h.roles},token:i,refreshToken:u,expiresIn:86400}:null}catch(e){return console.error("Error refreshing token:",e),null}})}validateToken(t){return n(this,null,function*(){try{let e=yield this.db.query("SELECT * FROM auth_tokens WHERE token = ?",[t]);if(!e.values||e.values.length===0)return null;let r=e.values[0];return new Date(r.expires_at)<new Date?(yield this.db.run("DELETE FROM auth_tokens WHERE user_id = ?",[r.user_id]),null):yield this.getUserById(r.user_id)}catch(e){return console.error("Error validating token:",e),null}})}getUserById(t){return n(this,null,function*(){try{let e=yield this.db.query("SELECT * FROM users WHERE id = ?",[t]);if(!e.values||e.values.length===0)return null;let r=e.values[0],i=(yield this.db.query("SELECT * FROM user_preferences WHERE user_id = ?",[t])).values?.[0]||{tema:"auto",idioma:"pt-BR",notificacoes_push:!0,notificacoes_email:!0};return{id:r.id,nome:r.nome,email:r.email,avatarUrl:r.avatar_url,telefone:r.telefone,dataNascimento:r.data_nascimento?this.db.sqlToDate(r.data_nascimento):void 0,bio:r.bio,roles:JSON.parse(r.roles),dataCriacao:this.db.sqlToDate(r.data_criacao),dataAtualizacao:this.db.sqlToDate(r.ultima_atualizacao),ativo:!!r.ativo,preferencias:{tema:i.tema,idioma:i.idioma,notificacoesPush:!!i.notificacoes_push,notificacoesEmail:!!i.notificacoes_email}}}catch(e){return console.error("Error getting user by ID:",e),null}})}updateUser(t,e){return n(this,null,function*(){try{let r=[],a=[];if(e.nome!==void 0&&(r.push("nome = ?"),a.push(e.nome)),e.email!==void 0&&(r.push("email = ?"),a.push(e.email)),e.avatarUrl!==void 0&&(r.push("avatar_url = ?"),a.push(e.avatarUrl)),r.length===0)return yield this.getUserById(t);r.push("ultima_atualizacao = ?"),a.push(this.db.dateToSQL(new Date)),a.push(t);let i=`UPDATE users SET ${r.join(", ")} WHERE id = ?`;return yield this.db.run(i,a),console.log("[SQLiteAuth] Forcing database save after user update..."),yield this.db.forceSave(),console.log("[SQLiteAuth] \u2705 Database saved successfully"),yield this.getUserById(t)}catch(r){throw console.error("Error updating user:",r),r}})}generateToken(){let t={alg:"HS256",typ:"JWT"},e={sub:this.db.generateId(),iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+1440*60},r=btoa(JSON.stringify(t)).replace(/=/g,""),a=btoa(JSON.stringify(e)).replace(/=/g,""),i=Array.from({length:43},()=>Math.floor(Math.random()*16).toString(16)).join("");return`${r}.${a}.${i}`}};s.\u0275fac=function(e){return new(e||s)(m(x))},s.\u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"});let o=s;return o})()});var Pe,Se=d(()=>{"use strict";C();_();se();ae();ne();B();Pe=(()=>{let s=class s{constructor(t,e,r,a){this.apiService=t,this.mockBackend=e,this.sqliteAuth=r,this.database=a,this.useSQLite=!1,this.useMockBackend=!0,this.TOKEN_KEY="auth_token",this.REFRESH_TOKEN_KEY="refresh_token",this.USER_KEY="user_data",this.currentUserSubject=new D(this.getUserFromStorage()),this.currentUser$=this.currentUserSubject.asObservable(),this.isAuthenticatedSubject=new D(this.hasValidToken()),this.isAuthenticated$=this.isAuthenticatedSubject.asObservable(),this.initPromise=null,this.initPromise=this.initializeDatabase(),this.checkTokenExpiration()}initializeDatabase(){return n(this,null,function*(){if((window.Capacitor?.getPlatform()||"web")!=="web")try{console.log("[AuthService] Native platform - Initializing SQLite database..."),yield this.database.initialize(),console.log("[AuthService] \u2705 SQLite database initialized successfully"),this.useSQLite=!0,this.useMockBackend=!1}catch(e){console.error("[AuthService] \u274C Failed to initialize SQLite on native platform:",e),this.useSQLite=!1,this.useMockBackend=!0}else console.log("[AuthService] Web platform - Using Mock Backend"),this.useSQLite=!1,this.useMockBackend=!0})}waitForInit(){return n(this,null,function*(){this.initPromise&&(yield this.initPromise)})}get currentUserValue(){return this.currentUserSubject.value}get isAuthenticated(){return this.isAuthenticatedSubject.value}login(t){return n(this,null,function*(){try{console.log("[AuthService] Login attempt START"),console.log("[AuthService] - useSQLite:",this.useSQLite),console.log("[AuthService] - useMockBackend:",this.useMockBackend),console.log("[AuthService] - credentials:",{email:t.email,passwordLength:t.password?.length});let e;return this.useSQLite?(console.log("[AuthService] Using SQLite authentication..."),yield this.waitForInit(),e=yield this.sqliteAuth.login(t),console.log("[AuthService] SQLite login response:",{success:!!e.token,userId:e.user?.id})):this.useMockBackend?(console.log("[AuthService] Using Mock Backend authentication..."),e=yield this.mockBackend.login(t),console.log("[AuthService] Mock login response:",{success:!!e.token,userId:e.user?.id})):(console.log("[AuthService] Using Real API authentication..."),e=yield O(this.apiService.post("auth/login",t)),console.log("[AuthService] API login response:",{success:!!e.token,userId:e.user?.id})),console.log("[AuthService] Setting session..."),this.setSession(e),console.log("[AuthService] Session set successfully"),console.log("[AuthService] isAuthenticated:",this.isAuthenticated),e}catch(e){throw console.error("[AuthService] Login error:",e),console.error("[AuthService] Error details:",JSON.stringify(e)),e}})}register(t){return n(this,null,function*(){try{let e;return this.useSQLite?e=yield this.sqliteAuth.register(t):this.useMockBackend?e=yield this.mockBackend.register(t):e=yield O(this.apiService.post("auth/register",t)),this.setSession(e),e}catch(e){throw e}})}logout(){return n(this,null,function*(){try{let t=this.currentUserValue?.id;this.useSQLite&&t?yield this.sqliteAuth.logout(t):this.useMockBackend||(yield O(this.apiService.post("auth/logout",{})))}catch(t){console.error("Logout error:",t)}finally{this.clearSession()}})}refreshToken(){return n(this,null,function*(){let t=this.getRefreshToken();if(!t)return this.clearSession(),null;try{let e;if(this.useSQLite)e=yield this.sqliteAuth.refreshToken(t);else if(!this.useMockBackend)e=yield O(this.apiService.post("auth/refresh",{refreshToken:t}));else return this.clearSession(),null;return e?this.setSession(e):this.clearSession(),e}catch(e){throw this.clearSession(),e}})}getToken(){return localStorage.getItem(this.TOKEN_KEY)}getRefreshToken(){return localStorage.getItem(this.REFRESH_TOKEN_KEY)}getCurrentUserId(){let t=localStorage.getItem(this.USER_KEY);if(t)try{return JSON.parse(t).id||null}catch{return null}return null}isAuthenticatedAndExists(){return n(this,null,function*(){let t=this.getToken(),e=this.getCurrentUserId();if(console.log("[AuthService:Check] Starting authentication check..."),console.log("[AuthService:Check] - Token exists:",!!t),console.log("[AuthService:Check] - User ID:",e),console.log("[AuthService:Check] - isAuthenticated:",this.isAuthenticated),console.log("[AuthService:Check] - useSQLite:",this.useSQLite),console.log("[AuthService:Check] - useMockBackend:",this.useMockBackend),!this.isAuthenticated||!t||!e)return console.log("[AuthService:Check] \u274C Falha: Token ou ID do usu\xE1rio ausente/inv\xE1lido."),!1;if(this.useMockBackend)return console.log("[AuthService:Check] \u2705 Usando Mock Backend. Token v\xE1lido encontrado. Acesso permitido."),!0;if(!this.useSQLite&&!this.useMockBackend)return console.log("[AuthService:Check] \u2705 Usando API Real. Confiando na validade do token."),!0;console.log("[AuthService:Check] Verificando no banco de dados SQLite..."),yield this.waitForInit();try{let r=yield this.database.query("SELECT id FROM users WHERE id = ?;",[e]),a=r.values&&r.values.length>0;return a?console.log(`[AuthService:Check] \u2705 Utilizador ID ${e} encontrado localmente.`):(console.log(`[AuthService:Check] \u274C Utilizador ID ${e} n\xE3o encontrado no banco de dados local.`),this.clearSession()),a}catch(r){return console.error("[AuthService:Check] \u274C Erro ao verificar utilizador no DB local:",r),this.useMockBackend?(console.log("[AuthService:Check] \u26A0\uFE0F Erro no SQLite mas Mock est\xE1 ativo. Permitindo acesso."),!0):(console.log("[AuthService:Check] \u274C Acesso negado devido a erro no SQLite."),this.clearSession(),!1)}})}setSession(t){try{let e={id:t.user.id,email:t.user.email,nome:t.user.nome,avatarUrl:t.user.avatarUrl};localStorage.setItem(this.TOKEN_KEY,t.token),localStorage.setItem(this.REFRESH_TOKEN_KEY,t.refreshToken),localStorage.setItem(this.USER_KEY,JSON.stringify(e)),this.currentUserSubject.next(t.user),this.isAuthenticatedSubject.next(!0)}catch(e){if(console.error("[AuthService] Error setting session:",e),e.name==="QuotaExceededError"){console.warn("[AuthService] Storage quota exceeded, clearing old data..."),this.clearSession();let r={id:t.user.id,email:t.user.email,nome:t.user.nome};localStorage.setItem(this.TOKEN_KEY,t.token),localStorage.setItem(this.REFRESH_TOKEN_KEY,t.refreshToken),localStorage.setItem(this.USER_KEY,JSON.stringify(r)),this.currentUserSubject.next(t.user),this.isAuthenticatedSubject.next(!0)}else throw e}}clearSession(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.REFRESH_TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}getUserFromStorage(){let t=localStorage.getItem(this.USER_KEY);return t?JSON.parse(t):null}hasValidToken(){let t=this.getToken();if(!t)return!1;if(this.useSQLite&&(!t.includes(".")||t.split(".").length!==3))return this.clearSession(),!1;if(this.useMockBackend)return!0;try{let e=this.decodeToken(t);return!(Date.now()>=e.exp*1e3)}catch{return this.clearSession(),!1}}decodeToken(t){let e=t.split(".");if(e.length!==3)throw new Error("Invalid token format");let r=e[1];if(!r)throw new Error("Invalid token payload");let a=r.replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(atob(a).split("").map(u=>"%"+("00"+u.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(i)}updateUser(t){return n(this,null,function*(){try{let e=this.currentUserValue?.id;if(!e)throw new Error("Usu\xE1rio n\xE3o est\xE1 autenticado");let r;if(this.useSQLite?(yield this.waitForInit(),r=yield this.sqliteAuth.updateUser(e,t)):this.useMockBackend?r=yield this.mockBackend.updateUser(e,t):r=yield O(this.apiService.patch("users/profile",t)),r){let a=this.currentUserValue;if(a){let i=g(f({},a),{nome:r.nome,email:r.email,avatarUrl:r.avatarUrl||r.avatar_url});localStorage.setItem(this.USER_KEY,JSON.stringify(i)),this.currentUserSubject.next(i)}}return r}catch(e){throw console.error("Error updating user:",e),e}})}checkTokenExpiration(){setInterval(()=>{!this.hasValidToken()&&this.isAuthenticated&&this.refreshToken().catch(()=>this.clearSession())},6e4)}};s.\u0275fac=function(e){return new(e||s)(m(re),m(oe),m(ie),m(x))},s.\u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"});let o=s;return o})()});export{ee as a,te as b,A as c,w as d,I as e,P as f,ue as g,Q as h,p as i,U as j,V as k,j as l,z as m,J as n,v as o,W as p,G as q,Y as r,$ as s,q as t,X as u,ge as v,Z as w,y as x,Pe as y,Se as z};
