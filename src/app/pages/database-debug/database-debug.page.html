<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/settings"></ion-back-button>
    </ion-buttons>
    <ion-title>Debug do Banco de Dados</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refresh()">
        <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Database Info -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Informações do Banco</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p><strong>Caminho:</strong> {{ databasePath }}</p>
      <p><strong>Tabelas:</strong> {{ tables.length }}</p>
      <p><strong>Backup:</strong> {{ backupInfo }}</p>

      <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
        <ion-button size="small" (click)="downloadAsJson()">
          <ion-icon slot="start" name="document-text-outline"></ion-icon>
          Exportar JSON
        </ion-button>
        <ion-button size="small" (click)="downloadAsSQLite()">
          <ion-icon slot="start" name="cloud-download-outline"></ion-icon>
          Exportar SQLite
        </ion-button>
        <ion-button size="small" color="danger" (click)="clearBackup()">
          <ion-icon slot="start" name="trash-outline"></ion-icon>
          Limpar Backup
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Table Viewer -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Visualizar Tabela</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-label>Selecione a tabela</ion-label>
        <ion-select [(ngModel)]="selectedTable" (ionChange)="onTableChange()">
          <ion-select-option *ngFor="let table of tables" [value]="table.name">
            {{ table.name }}
          </ion-select-option>
        </ion-select>
      </ion-item>

      <div *ngIf="selectedTable" style="margin-top: 16px;">
        <h3>Estrutura da Tabela</h3>
        <ion-list lines="none">
          <ion-item *ngFor="let column of tableStructure">
            <ion-label>
              <h3>{{ column.name }}</h3>
              <p>{{ column.type }} {{ column.notnull ? '(NOT NULL)' : '' }} {{ column.pk ? '(PK)' : '' }}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <h3 style="margin-top: 16px;">
          Dados ({{ tableData?.length || 0 }} registros)
        </h3>

        <div *ngIf="tableData && tableData.length > 0" style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr>
                <th *ngFor="let col of getColumns()" style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5; text-align: left;">
                  {{ col }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of tableData">
                <td *ngFor="let col of getColumns()" style="border: 1px solid #ddd; padding: 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ formatValue(row[col]) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p *ngIf="!tableData || tableData.length === 0" style="text-align: center; padding: 20px; color: #666;">
          Nenhum dado encontrado nesta tabela
        </p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Custom Query -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Query Personalizada</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-textarea
        [(ngModel)]="customQuery"
        placeholder="Digite sua query SQL aqui... Ex: SELECT * FROM users WHERE email LIKE '%@%'"
        rows="4"
        style="border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-family: monospace;"
      ></ion-textarea>

      <ion-button expand="block" (click)="executeCustomQuery()" style="margin-top: 8px;">
        <ion-icon slot="start" name="search-outline"></ion-icon>
        Executar Query
      </ion-button>

      <div *ngIf="queryResult && queryResult.length > 0" style="margin-top: 16px;">
        <h3>Resultado ({{ queryResult.length }} registros)</h3>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
              <tr>
                <th *ngFor="let col of Object.keys(queryResult[0])" style="border: 1px solid #ddd; padding: 8px; background-color: #f5f5f5; text-align: left;">
                  {{ col }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of queryResult">
                <td *ngFor="let col of Object.keys(row)" style="border: 1px solid #ddd; padding: 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ formatValue(row[col]) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <p *ngIf="queryResult !== null && queryResult.length === 0" style="text-align: center; padding: 20px; color: #666;">
        Nenhum resultado encontrado
      </p>
    </ion-card-content>
  </ion-card>

  <!-- Quick Query Examples -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Exemplos de Queries</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item button (click)="customQuery = 'SELECT * FROM users'; executeCustomQuery()">
          <ion-label>Ver todos os usuários</ion-label>
        </ion-item>
        <ion-item button (click)="customQuery = 'SELECT * FROM tasks ORDER BY data_criacao DESC LIMIT 10'; executeCustomQuery()">
          <ion-label>10 tarefas mais recentes</ion-label>
        </ion-item>
        <ion-item button (click)="customQuery = 'SELECT status, COUNT(*) as count FROM tasks GROUP BY status'; executeCustomQuery()">
          <ion-label>Contagem de tarefas por status</ion-label>
        </ion-item>
        <ion-item button (click)="customQuery = 'SELECT name FROM sqlite_master WHERE type=\'table\''; executeCustomQuery()">
          <ion-label>Listar todas as tabelas</ion-label>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

</ion-content>
